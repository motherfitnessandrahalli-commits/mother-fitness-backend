<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6c5ce7">
    <title>My QR Code - Mother Fitness</title>
    <link rel="stylesheet" href="./styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <a href="./dashboard.html" class="btn-back">‚Üê</a>
                <h1>My QR Code</h1>
            </div>
        </header>

        <main class="app-main">
            <div class="qr-container">
                <div class="qr-info">
                    <h2 id="memberName">Loading...</h2>
                    <p id="memberId"></p>
                    <div class="status-badge" id="statusBadge">Active</div>
                </div>

                <div id="qrcode" class="qr-code"></div>

                <div class="qr-instructions">
                    <p>üì± Show this QR code at gym entrance</p>
                    <p class="text-small">Scan to mark your attendance</p>
                </div>
            </div>
        </main>
    </div>

    <script src="./api.js"></script>
    <script src="./theme.js"></script>
    <script>
        const api = new MemberAPI();

        if (!api.token) {
            window.location.href = './index.html';
        }

        async function loadQRCode() {
            try {
                const response = await api.getProfile();
                const customer = response.data.customer;

                document.getElementById('memberName').textContent = customer.name;
                document.getElementById('memberId').textContent = customer.memberId;

                // Set status badge
                const status = getStatus(customer.validity);
                const badge = document.getElementById('statusBadge');
                badge.textContent = status.text;
                badge.className = `status-badge status-${status.class}`;

                // Generate QR Code
                const qrData = JSON.stringify({
                    type: 'ULTRA_FITNESS_MEMBER',
                    customerId: customer._id,
                    version: '1.0'
                });

                new QRCode(document.getElementById('qrcode'), {
                    text: qrData,
                    width: 280,
                    height: 280,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                });
            } catch (error) {
                alert('Failed to load QR code: ' + error.message);
            }
        }

        function getStatus(validity) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const validityDate = new Date(validity);
            validityDate.setHours(0, 0, 0, 0);
            const diffTime = validityDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return { text: 'Expired', class: 'expired' };
            } else if (diffDays <= 7) {
                return { text: 'Expiring Soon', class: 'expiring' };
            } else {
                return { text: 'Active', class: 'active' };
            }
        }

        loadQRCode();
    </script>
</body>

</html>