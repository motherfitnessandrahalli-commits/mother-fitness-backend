
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ultra Fitness Gym - Codebase Walkthrough</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            font-size: 2.5em;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            border-bottom: 2px solid #bdc3c7;
            padding-bottom: 5px;
            font-size: 2em;
        }
        h3 {
            color: #7f8c8d;
            margin-top: 25px;
            font-size: 1.5em;
        }
        h4 {
            color: #95a5a6;
            margin-top: 20px;
            font-size: 1.2em;
        }
        code {
            background: #f7f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #e74c3c;
        }
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            line-height: 1.4;
        }
        pre code {
            background: none;
            color: #ecf0f1;
            padding: 0;
        }
        blockquote {
            border-left: 4px solid #3498db;
            padding-left: 20px;
            color: #7f8c8d;
            font-style: italic;
            margin: 20px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }
        li {
            margin: 8px 0;
        }
        hr {
            border: none;
            border-top: 2px solid #bdc3c7;
            margin: 40px 0;
        }
        .mermaid {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        @media print {
            body {
                max-width: 100%;
            }
            h1, h2, h3 {
                page-break-after: avoid;
            }
            pre, table {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div id="content"></div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const mdContent = "# Ultra Fitness Gym Management System - Complete Codebase Walkthrough\r\n\r\n## Overview\r\n\r\nThis is a **full-stack gym management system** consisting of a Node.js/Express backend with MongoDB database and a vanilla JavaScript frontend. The system provides comprehensive gym operations including customer management, attendance tracking, analytics, and email notifications.\r\n\r\n---\r\n\r\n## ğŸ—ï¸ Architecture Overview\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph Frontend\r\n        HTML[index.html<br/>UI Structure]\r\n        CSS[styles.css<br/>Styling]\r\n        APP[app.js<br/>Application Logic]\r\n        API_CLIENT[api.js<br/>API Service Layer]\r\n    end\r\n    \r\n    subgraph Backend\r\n        SERVER[server.js<br/>Entry Point]\r\n        EXPRESS[Express App<br/>Middleware & Routes]\r\n        CONTROLLERS[Controllers<br/>Business Logic]\r\n        MODELS[MongoDB Models<br/>Data Schema]\r\n        SERVICES[Services<br/>Email, Socket.io]\r\n    end\r\n    \r\n    subgraph Database\r\n        MONGODB[(MongoDB)]\r\n    end\r\n    \r\n    HTML --> APP\r\n    CSS --> HTML\r\n    APP --> API_CLIENT\r\n    API_CLIENT -->|REST API| EXPRESS\r\n    SERVER --> EXPRESS\r\n    EXPRESS --> CONTROLLERS\r\n    CONTROLLERS --> MODELS\r\n    CONTROLLERS --> SERVICES\r\n    MODELS --> MONGODB\r\n```\r\n\r\n---\r\n\r\n## ğŸ“‚ Project Structure\r\n\r\n### Root Directory\r\n```\r\nc:/Users/Vinay/Downloads/ultra-fitness-gym 6.1 comp backend/\r\nâ”œâ”€â”€ index.html              # Main HTML file (login, UI components, modals)\r\nâ”œâ”€â”€ styles.css              # Complete styling (dark/light themes)\r\nâ”œâ”€â”€ app.js                  # Frontend application logic (~2000 lines)\r\nâ”œâ”€â”€ api.js                  # REST API client service layer\r\nâ”œâ”€â”€ APPLICATION_MANUAL.txt  # User manual\r\nâ”œâ”€â”€ PROJECT_STATUS.md       # Development status tracker\r\nâ””â”€â”€ ultra-fitness-backend/  # Backend directory\r\n```\r\n\r\n### Backend Directory  (`ultra-fitness-backend/`)\r\n```\r\nâ”œâ”€â”€ server.js                      # Main entry point\r\nâ”œâ”€â”€ package.json                   # Dependencies and scripts\r\nâ”œâ”€â”€ .env                           # Environment variables\r\nâ”œâ”€â”€ Dockerfile & docker-compose.yml # Deployment configuration\r\nâ”œâ”€â”€ src/\r\nâ”‚   â”œâ”€â”€ app.js                     # Express app configuration\r\nâ”‚   â”œâ”€â”€ config/                    # Configuration files\r\nâ”‚   â”‚   â”œâ”€â”€ database.js            # MongoDB connection\r\nâ”‚   â”‚   â”œâ”€â”€ logger.js              # Winston logging\r\nâ”‚   â”‚   â”œâ”€â”€ email.js               # Nodemailer setup\r\nâ”‚   â”‚   â”œâ”€â”€ socket.js              # Socket.io setup\r\nâ”‚   â”‚   â””â”€â”€ swagger.js             # API documentation\r\nâ”‚   â”œâ”€â”€ models/                    # Mongoose schemas\r\nâ”‚   â”‚   â”œâ”€â”€ User.js                # User authentication model\r\nâ”‚   â”‚   â”œâ”€â”€ Customer.js            # Customer/member model\r\nâ”‚   â”‚   â””â”€â”€ Attendance.js          # Attendance tracking model\r\nâ”‚   â”œâ”€â”€ controllers/               # Business logic handlers\r\nâ”‚   â”‚   â”œâ”€â”€ authController.js      # Login, register, password change\r\nâ”‚   â”‚   â”œâ”€â”€ customerController.js  # CRUD operations + stats\r\nâ”‚   â”‚   â”œâ”€â”€ attendanceController.js# Mark attendance + history\r\nâ”‚   â”‚   â”œâ”€â”€ analyticsController.js # Dashboard stats + charts\r\nâ”‚   â”‚   â”œâ”€â”€ uploadController.js    # Photo upload with Sharp\r\nâ”‚   â”‚   â””â”€â”€ notificationController.js # Email notifications\r\nâ”‚   â”œâ”€â”€ routes/                    # API endpoint definitions\r\nâ”‚   â”‚   â”œâ”€â”€ auth.routes.js\r\nâ”‚   â”‚   â”œâ”€â”€ customer.routes.js\r\nâ”‚   â”‚   â”œâ”€â”€ attendance.routes.js\r\nâ”‚   â”‚   â”œâ”€â”€ analytics.routes.js\r\nâ”‚   â”‚   â”œâ”€â”€ upload.routes.js\r\nâ”‚   â”‚   â””â”€â”€ notification.routes.js\r\nâ”‚   â”œâ”€â”€ middleware/                # Express middleware\r\nâ”‚   â”‚   â”œâ”€â”€ auth.js                # JWT verification\r\nâ”‚   â”‚   â”œâ”€â”€ validation.js          # Request validation\r\nâ”‚   â”‚   â””â”€â”€ upload.js              # Multer file upload\r\nâ”‚   â”œâ”€â”€ services/                  # Reusable services\r\nâ”‚   â”‚   â””â”€â”€ emailService.js        # Email sending logic\r\nâ”‚   â””â”€â”€ utils/                     # Helper functions\r\nâ”‚       â”œâ”€â”€ jwt.js                 # Token generation\r\nâ”‚       â”œâ”€â”€ errorHandler.js        # Error handling utilities\r\nâ”‚       â”œâ”€â”€ helpers.js             # Common helper functions\r\nâ”‚       â””â”€â”€ seeder.js              # Database seeding\r\nâ””â”€â”€ tests/                         # Jest test suites\r\n```\r\n\r\n---\r\n\r\n## ğŸ” Backend Deep Dive\r\n\r\n### 1. Server Entry Point ([server.js](file:///c:/Users/Vinay/Downloads/ultra-fitness-gym%206.1%20comp%20backend/ultra-fitness-backend/server.js))\r\n\r\n**Purpose**: Bootstraps the application\r\n\r\n**Key Operations**:\r\n- Loads environment variables\r\n- Creates HTTP server\r\n- Initializes Socket.io for real-time updates\r\n- Connects to MongoDB\r\n- Starts server on port 5000\r\n- Handles process errors (unhandledâ€‹Rejection, uncaughtException)\r\n\r\n### 2. Express Application ([src/app.js](file:///c:/Users/Vinay/Downloads/ultra-fitness-gym%206.1%20comp%20backend/ultra-fitness-backend/src/app.js))\r\n\r\n**Security Middleware**:\r\n- `helmet` - Security headers\r\n- `mongoSanitize` - NoSQL injection prevention\r\n- `xss-clean` - XSS attack protection\r\n- `hpp` - HTTP parameter pollution prevention\r\n- `cors` - Cross-origin requests (allows file:// protocol)\r\n- `rateLimit` - 100 requests per 15 minutes per IP\r\n\r\n**Features**:\r\n- JSON body parsing (10mb limit)  \r\n- Static file serving for `/uploads`\r\n- Swagger UI at `/api-docs`\r\n- Morgan HTTP logging\r\n- Global error handler\r\n\r\n**API Routes**:\r\n```javascript\r\n/api/auth          â†’ Authentication\r\n/api/customers     â†’ Customer management\r\n/api/upload        â†’ Photo uploads\r\n/api/attendance    â†’ Attendance tracking\r\n/api/analytics     â†’ Dashboard analytics\r\n/api/notifications â†’ Email notifications\r\n```\r\n\r\n### 3. Database Models\r\n\r\n#### User Model ([src/models/User.js](file:///c:/Users/Vinay/Downloads/ultra-fitness-gym%206.1%20comp%20backend/ultra-fitness-backend/src/models/User.js))\r\n\r\n**Schema**:\r\n```javascript\r\n{\r\n  email: String (unique, lowercase, validated)\r\n  password: String (bcrypt hashed, min 4 chars)\r\n  name: String\r\n  role: Enum['admin', 'staff', 'receptionist']\r\n  isActive: Boolean\r\n  timestamps: true (createdAt, updatedAt)\r\n}\r\n```\r\n\r\n**Methods**:\r\n- `comparePassword(candidatePassword)` - Compare hashed passwords\r\n- `toJSON()` - Exclude password from responses\r\n\r\n**Hooks**:\r\n- Pre-save: Auto-hash password with bcrypt (10 rounds)\r\n\r\n**Indexes**: `email` (unique)\r\n\r\n#### Customer Model ([src/models/Customer.js](file:///c:/Users/Vinay/Downloads/ultra-fitness-gym%206.1%20comp%20backend/ultra-fitness-backend/src/models/Customer.js))\r\n\r\n**Schema**:\r\n```javascript\r\n{\r\n  customerId: String (auto-generated, unique)\r\n  name: String (required)\r\n  age: Number (10-120)\r\n  email: String (required, validated)\r\n  phone: String (required)\r\n  plan: Enum['Monthly', 'Quarterly', 'Half-Yearly', 'Yearly']\r\n  validity: Date (required)\r\n  notes: String\r\n  photo: String (data URI or URL)\r\n  createdBy: ObjectId â†’ User\r\n  timestamps: true\r\n}\r\n```\r\n\r\n**Virtual Fields** (computed, not stored):\r\n- `status` - Returns 'active' | 'expiring' | 'expired' based on validity date\r\n  - Expired: `validity < today`\r\n  - Expiring: `validity between today and today+7 days`\r\n  - Active: `validity > today+7 days`\r\n- `daysRemaining` - Days until plan expires (negative if expired)\r\n\r\n**Hooks**:\r\n- Pre-save: Auto-generate `customerId` as `cust_{timestamp}_{random}`\r\n\r\n**Indexes**: `customerId`, `email`, `phone`, `validity`, `createdAt`\r\n\r\n#### Attendance Model ([src/models/Attendance.js](file:///c:/Users/Vinay/Downloads/ultra-fitness-gym%206.1%20comp%20backend/ultra-fitness-backend/src/models/Attendance.js))\r\n\r\n**Schema**:\r\n```javascript\r\n{\r\n  attendanceId: String (auto-generated)\r\n  customerId: ObjectId â†’ Customer\r\n  customerName: String\r\n  date: String (YYYY-MM-DD format)\r\n  time: String (HH:MM AM/PM)\r\n  timestamp: Date\r\n  membershipStatus: Enum['active', 'expiring', 'expired']\r\n  markedBy: ObjectId â†’ User\r\n  createdAt: true (no updatedAt)\r\n}\r\n```\r\n\r\n**Hooks**:\r\n- Pre-save: Auto-generate `attendanceId` as `att_{timestamp}_{random}`\r\n\r\n**Indexes**:\r\n- Compound: `{customerId, date}` (unique) - Prevents duplicate check-ins\r\n- Individual: `date`, `timestamp`, `membershipStatus`\r\n\r\n### 4. Controllers\r\n\r\n#### Authentication Controller ([src/controllers/authController.js](file:///c:/Users/Vinay/Downloads/ultra-fitness-gym%206.1%20comp%20backend/ultra-fitness-backend/src/controllers/authController.js))\r\n\r\n**Endpoints**:\r\n- `POST /api/auth/register` - Create new user (returns JWT token)\r\n- `POST /api/auth/login` - Authenticate user (validates active status)\r\n- `GET /api/auth/me` - Get current user info\r\n- `PUT /api/auth/change-password` - Update password (requires current password)\r\n\r\n**Flow**:\r\n1. Validate email/password\r\n2. Check user exists and is active\r\n3. Compare password with bcrypt\r\n4. Generate JWT token (expires per `.env` config)\r\n5. Return user object + token\r\n\r\n#### Customer Controller ([src/controllers/customerController.js](file:///c:/Users/Vinay/Downloads/ultra-fitness-gym%206.1%20comp%20backend/ultra-fitness-backend/src/controllers/customerController.js))\r\n\r\n**Endpoints**:\r\n- `GET /api/customers` - List with search, filter, pagination, sorting\r\n- `GET /api/customers/:id` - Get single customer\r\n- `POST /api/customers` - Create customer\r\n- `PUT /api/customers/:id` - Update customer\r\n- `DELETE /api/customers/:id` - Delete customer\r\n- `GET /api/customers/stats/overview` - Get counts by status\r\n\r\n**Advanced Features**:\r\n- **Search**: Fuzzy match on name, email, phone (case-insensitive regex)\r\n- **Status Filter**: Converts 'active'/'expiring'/'expired' to validity date queries\r\n- **Sorting**: By name, createdAt (newest/oldest), validity\r\n- **Pagination**: Default 10 per page, adjustable via `limit` param\r\n- **Real-time**: Broadcasts `customer:new` event via Socket.io on creation\r\n\r\n**Auto-calculation**:\r\nIf no `validity` provided, calculates based on plan type in helpersjs\r\n\r\n#### Attendance Controller ([src/controllers/attendanceController.js](file:///c:/Users/Vinay/Downloads/ultra-fitness-gym%206.1%20comp%20backend/ultra-fitness-backend/src/controllers/attendanceController.js))\r\n\r\n**Endpoints**:\r\n- `POST /api/attendance/mark` - Mark attendance (prevents duplicates)\r\n- `GET /api/attendance` - List attendance with filters (date, customer, status)\r\n- `GET /api/attendance/stats` - Daily + weekly stats\r\n- `GET /api/attendance/customer/:customerId` - Customer history (last 30)\r\n\r\n**Mark Attendance Logic**:\r\n1. Find customer by ID\r\n2. Get today's date in YYYY-MM-DD format (user's timezone)\r\n3. Check if already marked today (compound index prevents duplicates)\r\n4. Create attendance record with customer's current `status`\r\n5. Broadcast `attendance:new` via Socket.io\r\n\r\n**Stats Calculation**:\r\n- Daily: Total, active, expired counts for a date\r\n- Weekly: Last 7 days aggregation\r\n\r\n#### Analytics Controller ([src/controllers/analyticsController.js](file:///c:/Users/Vinay/Downloads/ultra-fitness-gym%206.1%20comp%20backend/ultra-fitness-backend/src/controllers/analyticsController.js))\r\n\r\n**Endpoints**:\r\n- `GET /api/analytics/dashboard` - Overall stats (customers + today's attendance)\r\n- `GET /api/analytics/plans` - Plan popularity (pie chart data)\r\n- `GET /api/analytics/demographics` - Age distribution (bar chart data)\r\n- `GET /api/analytics/growth` - Business growth (line chart, last 6 months)\r\n\r\n**Chart Data Format**:\r\nReturns both raw aggregation results and Chart.js-ready `{labels, data}` arrays\r\n\r\n**Age Demographics**:\r\nUses MongoDB `$bucket` aggregation with buckets:\r\n- Under 18 (0-17)\r\n- 18-25\r\n- 26-35\r\n- 36-50\r\n- 50+ (51-120)\r\n\r\n#### Notification Controller ([src/controllers/notificationController.js](file:///c:/Users/Vinay/Downloads/ultra-fitness-gym%206.1%20comp%20backend/ultra-fitness-backend/src/controllers/notificationController.js))\r\n\r\n**Endpoints**:\r\n- `POST /api/notifications/email/expired` - Send emails to expiring customers\r\n- `POST /api/notifications/email/custom` - Send custom email\r\n\r\n**Email Process**:\r\n1. Find customers with `validity` between today and today+7\r\n2. Generate HTML email from template (name, plan, expiry date)\r\n3. Send via Nodemailer in parallel (with error tracking)\r\n4. Return `{sent, failed, errors}`\r\n\r\n### 5. Middleware\r\n\r\n#### Authentication Middleware ([src/middleware/auth.js](file:///c:/Users/Vinay/Downloads/ultra-fitness-gym%206.1%20comp%20backend/ultra-fitness-backend/src/middleware/auth.js))\r\n\r\n**`protect` Middleware**:\r\n1. Extract JWT from `Authorization: Bearer {token}` header\r\n2. Verify token with `JWT_SECRET`\r\n3. Find user by decoded ID\r\n4. Check user exists and is active\r\n5. Attach user to `req.user` for controllers\r\n\r\n**`restrictTo(...roles)` Middleware**:\r\n- Checks if `req.user.role` matches  allowed roles\r\n- Returns 403 Forbidden if not authorized\r\n\r\n### 6. Services\r\n\r\n#### Email Service ([src/services/emailService.js](file:///c:/Users/Vinay/Downloads/ultra-fitness-gym%206.1%20comp%20backend/ultra-fitness-backend/src/services/emailService.js#L1-L50))\r\n\r\n**Configuration**: Nodemailer with Gmail SMTP\r\n- Uses `EMAIL_USER` and `EMAIL_APP_PASSWORD` from `.env`\r\n\r\n**Template Generation**:\r\n- `getExpiryTemplate(name, plan, validity)` - Returns HTML email with branding\r\n\r\n**Usage**: Called by notification controller\r\n\r\n---\r\n\r\n## ğŸ¨ Frontend Deep Dive\r\n\r\n### 1. HTML Structure ([index.html](file:///c:/Users/Vinay/Downloads/ultra-fitness-gym%206.1%20comp%20backend/index.html))\r\n\r\n**External Libraries**:\r\n- EmailJS - Email sending (client integration)\r\n- Chart.js - Analytics charts\r\n- SheetJS (XLSX) - Excel import/export\r\n- QRCodeJS - QR code generation\r\n- HTML5-QRCode - QR code scanning\r\n\r\n**Key Sections**:\r\n1. **Login Overlay** - Email/password form with error display\r\n2. **Header** - Logo + hamburger menu button\r\n3. **Dashboard Stats** - 4 stat cards (total, active, expiring, expired)\r\n4. **Search & Filters** - Search bar, status filter, sort dropdown\r\n5. **Customer List** - Dynamic card grid\r\n6. **Analytics Dashboard** - 3 Chart.js charts (hidden by default)\r\n7. **Attendance Dashboard** - Date filter, export button, check-in list\r\n\r\n**Modals** (Total: 9):\r\n- Customer Add/Edit Modal\r\n- Delete Confirmation Modal\r\n- Image Enlargement Modal\r\n- Camera Capture Modal\r\n- Change Password Modal\r\n- QR Code Display Modal\r\n- QR Code Scanner Modal\r\n- Attendance Success Modal\r\n- Hamburger Menu\r\n\r\n**Hamburger Menu Items**:\r\n- Add Customer\r\n- Scan QR Code\r\n- Attendance View\r\n- Analytics View\r\n- Import Excel\r\n- Export Excel\r\n- Dark/Light Mode Toggle\r\n- Change Password\r\n\r\n### 2. API Client Layer ([api.js](file:///c:/Users/Vinay/Downloads/ultra-fitness-gym%206.1%20comp%20backend/api.js))\r\n\r\n**Purpose**: Centralized HTTP client for backend communication\r\n\r\n**Configuration**:\r\n```javascript\r\nBASE_URL: 'http://localhost:5000'\r\n```\r\n\r\n**Token Management**:\r\n- Stores JWT in `sessionStorage` (session-based, cleared on tab close)\r\n- Auto-attaches `Authorization: Bearer {token}` to requests\r\n- Auto-redirects to login on 401 errors\r\n\r\n**API Methods** (30+ methods):\r\n\r\n**Authentication**:\r\n- `login(email, password)` â†’ `POST /api/auth/login`\r\n- `register(userData)` â†’ `POST /api/auth/register`\r\n- `getMe()` â†’ `GET /api/auth/me`\r\n- `changePassword(currentPassword, newPassword)` â†’ `PUT /api/auth/change-password`\r\n- `logout()` â†’ Clears token\r\n\r\n**Customers**:\r\n- `getCustomers(params)` â†’ `GET /api/customers?{queryString}`\r\n- `getCustomer(id)` â†’ `GET /api/customers/:id`\r\n- `createCustomer(customerData)` â†’ `POST /api/customers`\r\n- `updateCustomer(id, customerData)` â†’ `PUT /api/customers/:id`\r\n- `deleteCustomer(id)` â†’ `DELETE /api/customers/:id`\r\n- `getCustomerStats()` â†’ `GET /api/customers/stats/overview`\r\n\r\n**Attendance**:\r\n- `markAttendance(customerId)` â†’ `POST /api/attendance/mark`\r\n- `getAttendance(params)` â†’ `GET /api/attendance?{queryString}`\r\n- `getAttendanceStats(date)` â†’ `GET /api/attendance/stats?date={date}`\r\n- `getCustomerAttendance(customerId)` â†’ `GET /api/attendance/customer/:id`\r\n\r\n**Analytics**:\r\n- `getDashboardStats()` â†’ `GET /api/analytics/dashboard`\r\n- `getPlanPopularity()` â†’ `GET /api/analytics/plans`\r\n- `getAgeDemographics()` â†’ `GET /api/analytics/demographics`\r\n- `getBusinessGrowth()` â†’ `GET /api/analytics/growth`\r\n\r\n**Uploads**:\r\n- `uploadPhoto(file)` â†’ `POST /api/upload` (FormData, not JSON)\r\n- `deletePhoto(filename)` â†’ `DELETE /api/upload/:filename`\r\n\r\n**Notifications**:\r\n- `sendExpiryEmails()` â†’ `POST /api/notifications/email/expired`\r\n\r\n### 3. Application Logic ([app.js](file:///c:/Users/Vinay/Downloads/ultra-fitness-gym%206.1%20comp%20backend/app.js))\r\n\r\n**Classes**:\r\n\r\n#### `Customer` Class\r\n- Client-side data model matching backend schema\r\n- Methods: `getStatus()`, `getDaysRemaining()`\r\n\r\n#### `GymApp` Class (Main Application)\r\n\r\n**State Properties**:\r\n```javascript\r\ncustomers = [];              // Loaded from API\r\ncurrentFilter = 'all';        // Status filter\r\ncurrentSort = 'name';         // Sorting option\r\nsearchQuery = '';             // Search term\r\neditingCustomerId = null;     // For edit modal\r\ncurrentPhoto = '';            // Base64 photo data\r\ncurrentView = 'list';         // 'list' | 'analytics' | 'attendance'\r\napi = new API();              // API client instance\r\nisAuthenticated = false;      // Auth status\r\n```\r\n\r\n**Key Methods**:\r\n\r\n**Initialization**:\r\n- `init()` - Clears session token, shows login screen\r\n- `initializeApp()` - Called after login, loads customers, sets up listeners\r\n\r\n**Authentication**:\r\n- `handleLogin()` - Validates credentials via API, initializes app\r\n- `handleLogout()` - Clears token, reloads page\r\n- `handlePasswordChange()` - Updates password via API\r\n\r\n**Data Management**:\r\n- `loadCustomers()` - Fetches from `/api/customers`, maps to `Customer` objects\r\n- `addCustomer(customerData)` - Creates via API, updates local state\r\n- `updateCustomer(id, customerData)` - Updates via API, refreshes local state\r\n- `deleteCustomer(id)` - Deletes via API, filters local array\r\n\r\n**Filtering & Rendering**:\r\n- `getFilteredCustomers()` - Applies search + status filter + sorting\r\n- `getStats()` - Calculates local statistics\r\n- `render()` - Updates DOM with filtered customers\r\n\r\n**QR Code System**:\r\n- `generateQRCode(customerId)` - Generates QR with customer ID\r\n- `openScannerModal()` - Starts HTML5-QRCode scanner\r\n- `markAttendance(customerId)` - Calls API, plays audio alert\r\n- `playBeep(duration)` - Short beep for active members\r\n- `playVoiceAlert(message)` - Voice alert for expired members\r\n\r\n**Attendance View**:\r\n- `renderAttendance()` - Fetches `/api/attendance` filtered by date\r\n- `exportAttendance()` - Exports to Excel using SheetJS\r\n\r\n**Analytics View**:\r\n- `renderAnalytics()` - Fetches chart data, renders 3 Chart.js charts\r\n  - Pie chart: Plan popularity\r\n  - Bar chart: Age demographics\r\n  - Line chart: 6-month business growth\r\n\r\n**Photo Management**:\r\n- `openCameraModal()` - Starts webcam stream via `getUserMedia`\r\n- `capturePhoto()` - Captures canvas frame, converts to base64\r\n- `handlePhotoUpload(event)` - Reads file input, converts to base64\r\n\r\n**Excel Import/Export**:\r\n- `importCustomersFromExcel(event)` - Reads XLSX file, batch adds customers\r\n- `exportToExcel()` - Exports customer list with status to XLSX\r\n\r\n**Theme**:\r\n- `loadTheme()` - Loads from localStorage\r\n- `toggleTheme()` - Switches dark/light mode, saves preference\r\n\r\n**Notifications**:\r\n- `showNotification(type, title, message)` - Shows toast (auto-dismisses in 5s)\r\n\r\n---\r\n\r\n## ğŸ”„ Data Flow Examples\r\n\r\n### Login Flow\r\n\r\n```mermaid\r\nsequenceDiagram\r\n    participant U as User\r\n    participant FE as Frontend (app.js)\r\n    participant API as API Client (api.js)\r\n    participant BE as Backend (authController)\r\n    participant DB as MongoDB\r\n    \r\n    U->>FE: Enter email/password, click Login\r\n    FE->>API: login(email, password)\r\n    API->>BE: POST /api/auth/login\r\n    BE->>DB: Find user by email\r\n    DB-->>BE: User document\r\n    BE->>BE: Compare password (bcrypt)\r\n    BE->>BE: Generate JWT token\r\n    BE-->>API: {user, token, status: 'success'}\r\n    API->>API: Store token in sessionStorage\r\n    API-->>FE: Response data\r\n    FE->>FE: Hide login overlay\r\n    FE->>FE: initializeApp()\r\n    FE->>API: getCustomers()\r\n    API->>BE: GET /api/customers\r\n    BE->>DB: Find all customers\r\n    DB-->>BE: Customer array\r\n    BE-->>API: {customers, pagination}\r\n    API-->>FE: Customer data\r\n    FE->>FE: Map to Customer objects, render()\r\n```\r\n\r\n### Mark Attendance Flow\r\n\r\n```mermaid\r\nsequenceDiagram\r\n    participant U as User\r\n    participant FE as Frontend (app.js)\r\n    participant SCAN as QR Scanner\r\n    participant API as API Client\r\n    participant BE as Backend (attendanceController)\r\n    participant DB as MongoDB\r\n    participant WS as Socket.io\r\n\r\n    U->>FE: Click \"Scan QR Code\"\r\n    FE->>SCAN: Start HTML5-QRCode scanner\r\n    U->>SCAN: Show QR code to camera\r\n    SCAN->>FE: Decoded customer ID\r\n    FE->>API: markAttendance(customerId)\r\n    API->>BE: POST /api/attendance/mark {customerId}\r\n    BE->>DB: Find customer by ID\r\n    DB-->>BE: Customer document (with status)\r\n    BE->>DB: Check duplicate (composite index)\r\n    DB-->>BE: No record for today\r\n    BE->>DB: Create attendance record\r\n    DB-->>BE: Saved attendance\r\n    BE->>WS: Emit 'attendance:new' event\r\n    BE-->>API: {attendance, status: 'success'}\r\n    API-->>FE: Attendance data\r\n    alt Status is 'active'\r\n        FE->>FE: Play short success beep\r\n        FE->>FE: Show success modal (green)\r\n    else Status is 'expired'\r\n        FE->>FE: Play long warning beep\r\n        FE->>FE: Speak \"Membership expired\"\r\n        FE->>FE: Show warning modal (red)\r\n    end\r\n    FE->>FE: Close scanner modal\r\n```\r\n\r\n### Analytics Rendering Flow\r\n\r\n```mermaid\r\nsequenceDiagram\r\n    participant U as User\r\n    participant FE as Frontend (app.js)\r\n    participant API as API Client\r\n    participant BE as Backend (analyticsController)\r\n    participant DB as MongoDB\r\n    participant CHART as Chart.js\r\n\r\n    U->>FE: Click \"Analytics\" in menu\r\n    FE->>FE: currentView = 'analytics'\r\n    FE->>FE: Show analytics section\r\n    \r\n    par Fetch Plan Data\r\n        FE->>API: getPlanPopularity()\r\n        API->>BE: GET /api/analytics/plans\r\n        BE->>DB: Aggregate by plan field\r\n        DB-->>BE: {_id: 'Monthly', count: 15}, ...\r\n        BE-->>API: {labels: ['Monthly'...], data: [15...]}\r\n        API-->>FE: Plan data\r\n        FE->>CHART: Render pie chart\r\n    and Fetch Demographics\r\n        FE->>API: getAgeDemographics()\r\n        API->>BE: GET /api/analytics/demographics\r\n        BE->>DB: $bucket aggregation on age\r\n        DB-->>BE: Age buckets\r\n        BE-->>API: {labels: ['18-25'...], data: [20...]}\r\n        API-->>FE: Demographics data\r\n        FE->>CHART: Render bar chart\r\n    and Fetch Growth\r\n        FE->>API: getBusinessGrowth()\r\n        API->>BE: GET /api/analytics/growth\r\n        BE->>DB: Aggregate by month for last 6 months\r\n        DB-->>BE: Monthly counts\r\n        BE-->>API: {labels: ['Nov 2024'...], data: [5...]}\r\n        API-->>FE: Growth data\r\n        FE->>CHART: Render line chart\r\n    end\r\n```\r\n\r\n---\r\n\r\n## ğŸ” Authentication & Security\r\n\r\n### JWT Token Flow\r\n\r\n**Token Generation** (backend):\r\n```javascript\r\n// utils/jwt.js\r\njwt.sign({ id: user._id }, process.env.JWT_SECRET, {\r\n    expiresIn: process.env.JWT_EXPIRE || '7d'\r\n})\r\n```\r\n\r\n**Token Storage** (frontend):\r\n```javascript\r\n// api.js\r\nsessionStorage.setItem('token', token);  // Session-based, cleared on tab close\r\n```\r\n\r\n**Token Verification** (backend middleware):\r\n```javascript\r\n// middleware/auth.js\r\nconst decoded = jwt.verify(token, process.env.JWT_SECRET);\r\nconst user = await User.findById(decoded.id);\r\nreq.user = user;  // Attach to request\r\n```\r\n\r\n**Auto-logout on 401**:\r\n```javascript\r\n// api.js\r\nif (response.status === 401) {\r\n    this.clearToken();\r\n    window.location.reload();  // Force re-login\r\n}\r\n```\r\n\r\n### Security Measures\r\n\r\n**Backend**:\r\n- âœ… Password hashing (bcrypt, 10 rounds)\r\n- âœ… NoSQL injection prevention (mongo-sanitize)\r\n- âœ… XSS protection (xss-clean)\r\n- âœ… HTTP parameter pollution (hpp)\r\n- âœ… Rate limiting (100 req/15min)\r\n- âœ… Security headers (Helmet)\r\n- âœ… CORS with credentials\r\n- âœ… JWT expiration\r\n- âœ… Role-based access control\r\n\r\n**Frontend**:\r\n- âœ… Session-based auth (no persistent storage)\r\n- âœ… Auto-logout on failed auth\r\n- âœ… Password validation (min 4 chars)\r\n- âœ… Input sanitization for API calls\r\n\r\n---\r\n\r\n## ğŸ“Š Database Schema\r\n\r\n### User Collection\r\n```javascript\r\n{\r\n  _id: ObjectId,\r\n  email: \"admin@ultrafitness.com\",\r\n  password: \"$2a$10$...\", // bcrypt hash\r\n  name: \"Admin User\",\r\n  role: \"admin\",  // or \"staff\", \"receptionist\"\r\n  isActive: true,\r\n  createdAt: ISODate,\r\n  updatedAt: ISODate\r\n}\r\n```\r\n\r\n### Customer Collection\r\n```javascript\r\n{\r\n  _id: ObjectId,\r\n  customerId: \"cust_1733221234567_abc123def\",  // Auto-generated\r\n  name: \"John Doe\",\r\n  age: 28,\r\n  email: \"john@example.com\",\r\n  phone: \"+91 98765 43210\",\r\n  plan: \"Quarterly\",  // Monthly | Quarterly | Half-Yearly | Yearly\r\n  validity: ISODate(\"2024-03-15\"),\r\n  notes: \"Prefers morning workouts\",\r\n  photo: \"data:image/jpeg;base64,...\",  // Or upload URL\r\n  createdBy: ObjectId â†’ User,\r\n  createdAt: ISODate,\r\n  updatedAt: ISODate\r\n}\r\n```\r\n\r\n### Attendance Collection\r\n```javascript\r\n{\r\n  _id: ObjectId,\r\n  attendanceId: \"att_1733221234567_xyz789ghi\",  // Auto-generated\r\n  customerId: ObjectId â†’ Customer,\r\n  customerName: \"John Doe\",  // Denormalized for performance\r\n  date: \"2024-12-04\",  // YYYY-MM-DD string\r\n  time: \"09:30 AM\",\r\n  timestamp: ISODate(\"2024-12-04T09:30:00Z\"),\r\n  membershipStatus: \"active\",  // Snapshot at check-in time\r\n  markedBy: ObjectId â†’ User,\r\n  createdAt: ISODate\r\n}\r\n```\r\n\r\n---\r\n\r\n## ğŸ¯ Key Features\r\n\r\n### 1. QR Code Attendance System\r\n\r\n**Generation**:\r\n- Each customer gets a unique QR code containing their MongoDB `_id`\r\n- Generated using QRCodeJS library\r\n- Downloadable as PNG\r\n\r\n**Scanning**:\r\n- Uses device camera via HTML5-QRCode library\r\n- Auto-detects and decodes QR code\r\n- Prevents duplicate check-ins (same day)\r\n- Audio feedback:\r\n  - **Active members**: Short beep\r\n  - **Expired members**: Long beep + voice alert \"Membership expired\"\r\n\r\n**Backend Prevention**:\r\n- Compound unique index on `{customerId, date}` ensures one check-in per day\r\n- Returns 400 error if duplicate attempted\r\n\r\n### 2. Analytics Dashboard\r\n\r\n**Three Chart.js Charts**:\r\n\r\n1. **Plan Popularity** (Pie Chart)\r\n   - Shows distribution across Monthly/Quarterly/Half-Yearly/Yearly\r\n   - Uses MongoDB `$group` aggregation\r\n\r\n2. **Age Demographics** (Bar Chart)\r\n   - Groups: Under 18, 18-25, 26-35, 36-50, 50+\r\n   - Uses MongoDB `$bucket` aggregation\r\n\r\n3. **Business Growth** (Line Chart)\r\n   - Last 6 months of new customer sign-ups\r\n   - Fills missing months with 0\r\n   - Uses MongoDB aggregation by month/year\r\n\r\n### 3. Excel Import/Export\r\n\r\n**Import**:\r\n- Reads XLSX files with SheetJS\r\n- Expected columns: Name, Age, Email, Phone, Plan, Validity, Notes\r\n- Batch creates customers via API\r\n- Shows success/fail count\r\n\r\n**Export**:\r\n- Exports all customers with status calculation\r\n- Includes: Name, Age, Email, Phone, Plan, Validity, Status, Notes, Joined Date\r\n- Downloads as `UltraFitness_Customers_YYYY-MM-DD.xlsx`\r\n\r\n### 4. Email Notifications\r\n\r\n**Integration**: EmailJS (client-side) + Nodemailer (server-side)\r\n\r\n**Flow**:\r\n- Frontend triggers `/api/notifications/email/expired`\r\n- Backend finds customers expiring in next 7 days\r\n- Generates HTML email with gym branding\r\n- Sends via Nodemailer SMTP\r\n- Returns success/failure counts\r\n\r\n**Template Variables**:\r\n- Customer name\r\n- Plan type\r\n- Expiry date\r\n- Gym name\r\n\r\n### 5. Real-time Updates (Socket.io)\r\n\r\n**Events**:\r\n- `customer:new` - Broadcast when customer created\r\n- `attendance:new` - Broadcast when attendance marked\r\n- `dashboard:update` - Trigger dashboard refresh\r\n\r\n**Backend Emission**:\r\n```javascript\r\nconst { getIO } = require('../config/socket');\r\nconst io = getIO();\r\nio.emit('customer:new', customer);\r\n```\r\n\r\n**Frontend** (Not yet subscribed in current code, but infrastructure ready)\r\n\r\n### 6. Photo Upload System\r\n\r\n**Capture Methods**:\r\n1. **Live Camera**: Uses `getUserMedia` API, captures canvas frame\r\n2. **File Upload**: Accepts image files, reads as base64\r\n\r\n**Storage**:\r\n- **Frontend**: Stores as base64 data URI in `currentPhoto` state\r\n- **Backend Option 1**: Stores base64 in MongoDB (current)\r\n- **Backend Option 2**: Uses Multer + Sharp for file upload optimization\r\n\r\n**Sharp Processing** (in upload controller):\r\n- Resizes to max 800x800px\r\n- Compresses to 80% quality\r\n- Converts to JPEG\r\n- Saves to `/uploads` directory\r\n\r\n---\r\n\r\n## ğŸš€ How to Run\r\n\r\n### Backend\r\n\r\n```bash\r\ncd ultra-fitness-backend\r\nnpm install\r\nnpm run seed       # Populate database with sample data\r\nnpm run dev        # Start with nodemon (auto-restart)\r\n# OR\r\nnpm start          # Production mode\r\n```\r\n\r\n**Environment Variables** (`.env`):\r\n```env\r\nNODE_ENV=development\r\nPORT=5000\r\nMONGODB_URI=mongodb://localhost:27017/ultra-fitness\r\nJWT_SECRET=your_secret_key_here\r\nJWT_EXPIRE=7d\r\nRATE_LIMIT_WINDOW_MS=900000\r\nRATE_LIMIT_MAX_REQUESTS=100\r\nEMAIL_USER=your_email@gmail.com\r\nEMAIL_APP_PASSWORD=your_app_password_here\r\n```\r\n\r\n**Access**:\r\n- API: `http://localhost:5000`\r\n- API Docs: `http://localhost:5000/api-docs`\r\n- Health Check: `http://localhost:5000/health`\r\n\r\n**Default Credentials** (after seeding):\r\n- Admin: `admin@ultrafitness.com` / `0000`\r\n- Staff: `staff@ultrafitness.com` / `0000`\r\n\r\n### Frontend\r\n\r\n**Option 1: Direct File Opening**\r\n- Open `index.html` in browser\r\n- CORS is enabled for `file://` protocol\r\n\r\n**Option 2: Live Server (VSCode)**\r\n```bash\r\n# Install Live Server extension\r\n# Right-click index.html â†’ Open with Live Server\r\n```\r\n\r\n**Option 3: Simple HTTP Server**\r\n```bash\r\n# Python\r\npython -m http.server 8000\r\n\r\n# Node.js\r\nnpx http-server -p 8000\r\n```\r\n\r\n**Login**:\r\nUse credentials from backend seeding\r\n\r\n---\r\n\r\n## ğŸ“¦ Dependencies\r\n\r\n### Backend\r\n\r\n**Core**:\r\n- `express` - Web framework\r\n- `mongoose` - MongoDB ODM\r\n- `dotenv` - Environment variables\r\n- `cors` - Cross-origin requests\r\n- `socket.io` - Real-time communication\r\n\r\n**Security**:\r\n- `bcryptjs` - Password hashing\r\n- `jsonwebtoken` - JWT authentication\r\n- `helmet` - Security headers\r\n- `express-mongo-sanitize` - NoSQL injection prevention\r\n- `xss-clean` - XSS protection\r\n- `hpp` - Parameter pollution prevention\r\n- `express-rate-limit` - Rate limiting\r\n\r\n**File Handling**:\r\n- `multer` - File upload middleware\r\n- `sharp` - Image processing\r\n\r\n**Email**:\r\n- `nodemailer` - Email sending\r\n\r\n**Validation**:\r\n- `joi` - Schema validation\r\n\r\n**Documentation**:\r\n- `swagger-jsdoc` - API documentation generation\r\n- `swagger-ui-express` - Swagger UI\r\n\r\n**Logging**:\r\n- `winston` - Logging library\r\n- `morgan` - HTTP request logger\r\n\r\n**Dev Tools**:\r\n- `nodemon` - Auto-restart on changes\r\n- `jest` - Testing framework\r\n- `supertest` - HTTP assertions\r\n- `cross-env` - Cross-platform environment variables\r\n\r\n### Frontend (CDN)\r\n\r\n- **EmailJS** - Client-side email service\r\n- **Chart.js** - Data visualization\r\n- **SheetJS (XLSX)** - Excel file handling\r\n- **QRCodeJS** - QR code generation\r\n- **HTML5-QRCode** - QR code scanning\r\n- **Google Fonts** - Inter font family\r\n\r\n---\r\n\r\n## ğŸ—‚ï¸ API Endpoints Summary\r\n\r\n### Authentication\r\n| Method | Endpoint | Description | Auth |\r\n|--------|----------|-------------|------|\r\n| POST | `/api/auth/register` | Create new user account | No |\r\n| POST | `/api/auth/login` | Login with email/password | No |\r\n| GET | `/api/auth/me` | Get current user profile | Yes |\r\n| PUT | `/api/auth/change-password` | Update password | Yes |\r\n\r\n### Customers\r\n| Method | Endpoint | Description | Auth |\r\n|--------|----------|-------------|------|\r\n| GET | `/api/customers` | List customers (search, filter, paginate) | Yes |\r\n| GET | `/api/customers/:id` | Get single customer | Yes |\r\n| POST | `/api/customers` | Create customer | Yes |\r\n| PUT | `/api/customers/:id` | Update customer | Yes |\r\n| DELETE | `/api/customers/:id` | Delete customer | Yes |\r\n| GET | `/api/customers/stats/overview` | Get customer statistics | Yes |\r\n\r\n### Attendance\r\n| Method | Endpoint | Description | Auth |\r\n|--------|----------|-------------|------|\r\n| POST | `/api/attendance/mark` | Mark attendance for customer | Yes |\r\n| GET | `/api/attendance` | List attendance records | Yes |\r\n| GET | `/api/attendance/stats` | Daily/weekly statistics | Yes |\r\n| GET | `/api/attendance/customer/:id` | Customer attendance history | Yes |\r\n\r\n### Analytics\r\n| Method | Endpoint | Description | Auth |\r\n|--------|----------|-------------|------|\r\n| GET | `/api/analytics/dashboard` | Dashboard overview stats | Yes |\r\n| GET | `/api/analytics/plans` | Plan popularity data | Yes |\r\n| GET | `/api/analytics/demographics` | Age demographics | Yes |\r\n| GET | `/api/analytics/growth` | Business growth (6 months) | Yes |\r\n\r\n### Uploads\r\n| Method | Endpoint | Description | Auth |\r\n|--------|----------|-------------|------|\r\n| POST | `/api/upload` | Upload photo (multipart/form-data) | Yes |\r\n| DELETE | `/api/upload/:filename` | Delete uploaded photo | Yes |\r\n\r\n### Notifications\r\n| Method | Endpoint | Description | Auth |\r\n|--------|----------|-------------|------|\r\n| POST | `/api/notifications/email/expired` | Send expiry emails | Yes |\r\n| POST | `/api/notifications/email/custom` | Send custom email | Yes |\r\n\r\n---\r\n\r\n## ğŸ¨ UI Design Features\r\n\r\n### Dark/Light Theme\r\n- Default: Dark mode with gradient backgrounds\r\n- Toggle via hamburger menu\r\n- Persists in localStorage\r\n- CSS custom properties for easy theming\r\n\r\n### Responsive Design\r\n- Mobile-first approach\r\n- Hamburger menu for mobile navigation\r\n- Stat cards stack on small screens\r\n- Chart responsiveness via Chart.js config\r\n\r\n### Animations\r\n- Smooth modal transitions (scale + fade)\r\n- Notification slide-in from right\r\n- Loading spinner overlay\r\n- Success/error color coding\r\n\r\n### UX Patterns\r\n- Loading states for all async operations\r\n- Toast notifications (auto-dismiss 5s)\r\n- Modal confirmations for destructive actions\r\n- Empty states with call-to-action buttons\r\n- Inline validation on forms\r\n\r\n---\r\n\r\n## ğŸ”§ Code Quality & Best Practices\r\n\r\n### Backend\r\n\r\n**âœ… Implemented**:\r\n- Async error handling with `asyncHandler` wrapper\r\n- Centralized error handling middleware\r\n- Environment-based configuration\r\n- Mongoose schema validation\r\n- Pre-save hooks for data transformation\r\n- Virtual fields for computed properties\r\n- Compound indexes for query optimization\r\n- JWT token verification middleware\r\n- Role-based access control\r\n- Logging with Winston\r\n- API documentation with Swagger\r\n- Docker containerization\r\n\r\n**ğŸ“ Areas for Improvement**:\r\n- Add comprehensive test coverage (tests directory exists but minimal tests)\r\n- Implement request validation with Joi schemas\r\n- Add API versioning (e.g., `/api/v1/`)\r\n- Implement pagination metadata in all list endpoints\r\n- Add soft delete for customers (isDeleted flag)\r\n- Implement file size limits for uploads\r\n- Add database transaction support for critical operations\r\n\r\n### Frontend\r\n\r\n**âœ… Implemented**:\r\n- Centralized API client with token management\r\n- Error handling with user-friendly notifications\r\n- State management in GymApp class\r\n- Separation of concerns (API layer vs business logic)\r\n- Loading states for async operations\r\n- Local storage for theme preference\r\n- Session storage for authentication\r\n\r\n**ğŸ“ Areas for Improvement**:\r\n- Move to a framework (React/Vue) for better state management\r\n- Implement proper form validation library\r\n- Add TypeScript for type safety\r\n- Split large app.js file into modules\r\n- Implement client-side routing\r\n- Add service worker for offline support\r\n- Optimize image compression before upload\r\n\r\nThis walkthrough provides a comprehensive understanding of the entire Ultra Fitness Gym Management System. The system demonstrates a well-architected full-stack application with modern best practices in both backend and frontend development.\r\n";
        document.getElementById('content').innerHTML = marked.parse(mdContent);
    </script>
</body>
</html>
